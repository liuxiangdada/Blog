### JS事件类型

在理解JS事件的运行流程之前，我们要先了解一下JS的事件类型：宏任务和微任务

#### 宏任务

宏任务通常为以下这些：

- UI渲染
- JS脚本执行
- 用户交互事件
- 定时器
- 网络请求和文件读写
- setImmediate

浏览器为了能够使得JS内部任务与DOM任务能够有序的执行，会在每次宏任务执行完成后重新渲染页面

#### 微任务

引入微任务主要目的就是解决异步回调的问题，所以常见的微任务有

- ajax请求
- promise
- promise衍生出的generate、async、fetch等技术
- Object.observer
- MutationObserver

微任务会在当前宏任务执行完毕后立即执行，即顺序为宏任务 > 微任务 > 重新渲染 > 下一个宏任务

### 执行机制和事件循环

主线程首先跑主体代码，期间产生堆、栈、队列三个东西，堆中存放对象，栈中执行具体的函数操作，如果发现有任务不能马上完成，会将其回调放入任务队列中，主线程继续执行下面的代码

放入任务队列的事件分为宏任务事件和微任务事件，比如我们设置一个定时器，当执行完主体代码后，发现了宏任务队列中的定时器回调，然后执行该回调，清空执行栈

主线程是如何知道什么时候执行完毕呢，JS引擎中有一个monitoring process进程，该进程不断的检查主线程的执行栈是否为空，为空则去队列检查是否有待执行的事件

**事件循环的基本规则就是每次执行宏任务都可能会注册新的宏任务和微任务，但是一定满足每执行一个宏任务，就会清空事件队列中的微任务**

### 举个例子

事件执行的基本流程总结为：

- 执行JS脚本
- 发现微任务，将微任务的回调放入微任务队列中
- 发现定时器，将定时器的回调加入宏任务队列
- 执行主代码宏任务完成，检查微任务队列，执行其中的事件
- 渲染页面
- 检查是否有Web worker任务，有则执行
- 执行下一个宏任务

```
console.log('主线程执行开始');

new Promise(function(resolve, reject) {
  console.log('猜猜我什么时候执行')
  resolve()
}).then(() => {
  console.log('微任务执行开始')
})

setTimeout(function() {
  console.log('下一个宏任务执行开始');
})

console.log('主线程执行完成');

// 主线程执行开始
// 猜猜我什么时候执行
// 主线程执行完成
// 微任务执行开始
// 下一个宏任务执行开始

```



