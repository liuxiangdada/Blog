# 微信小程序开发须知

## 前提

微信小程序开发是当前Web开发的流行趋势，借助微信的巨大流量，实现自身业务在微信端的增长是大部分公司的基本业务需求，目前主流的开发模式主要分为原生开发和框架开发，本文主要介绍原生开发模式，框架开发自行学习

### 框架对比

#### uni-app

uni-app是一款使用Vue语言的多端开发框架，借助uni-app可以使用Vue的语法和微信API快速开发出小程序，目前uni-app社区比较活跃，提的issue也会很快响应，社区也有很多现成组件，对于多端需求的项目是很方便的

uni-app的坑：依赖uni-app开发团队，由于其bug比较多，经常修复，存在升级包后无法正常打包的问题

#### taro

taro是京东团队开发的一款多端框架，基于React实现，社区不如uni-app活跃，适合有基础的React框架使用者

#### 原生

使用微信小程序语法开发，只能打包应用在微信小程序，是官方推荐的开发模式，学习成本相对来说简单一点，适用于没有多端需求并且原来未接触过其他框架的初始开发者，由于本身只提供基本语法，因此需要借助gulp、webpack构建工作流来提升开发速度

## 环境

- 微信开发者工具
- 编辑器（IDE）：推荐VS Code
- NodeJS环境：>10.0

## 工作流搭建

目前主流的工作流构建工具有gulp和webpack，这里选择gulp是因为其学习成本小、小程序天然适合gulp的工作模式、使用webpack的打包功能过于繁琐且没有必要

### less

小程序本身只支持原生css，我们可以使用less提升效率，然后借助`gulp-less`插件将less编译为wxss

### css

- 编译后的css理论上需要压缩以减少上传代码的体积，我们使用`gulp-postcss`插件压缩css
- 微信内置浏览器其实是X5内核的，该内核基于webkit优化而来，所以理论上不需要添加css前缀，但是我们为避免不必要情况，加上，使用`autoprefixer`包，并在`postcss.config.js`文件配置
  
### ts

ts开发带来的类型检查和自动补全让开发中出现低级错误的几率减小，使用起来真的很香，如果我们要使用ts开发，则需要手动编译成js，既可以使用`gulp-typescript`插件，也可以使用ts命令行`tsc`命令编译

### js

出于代码体积和安全考虑，编译后的js代码需要进行压缩混淆，我们使用`gulp-uglify-es`插件压缩代码，使用`gulp-javascript-obfuscator`插件混淆代码

### 资源

- 字体，微信小程序不支持在css引用本地文件，所以需要将字体文件转成base64编码，使用`gulp-base64-v2`插件
- 图片，因为上面提到的限制，同理

### 其他文件

诸如js插件、JSON文件、css插件、html文件等不需要处理而要直接复制到dist文件夹中，我们使用`rimraf`包清空dist文件夹，使用`gulp-changed`插件监听文件变动，直接用`gulp-dest`写入dist文件夹中

### 开发环境

- 针对本地开发环境，我们需要less编译、ts转js、监听实时编译、修改配置环境等功能，所以需要使用`gulp-replace`插件修改配置文件内容，并利用`gulp-watch`监听文件
- 针对测试环境和生产环境，则需要修改api接口地址为线上地址，不需要启用监听

## 开发注意事项

1. 在css中使用本地图片会报错，必须先将图片转成base64才能使用，如果使用的背景图片很大，转化出来的背景图的编码也多，影响阅读，增加代码体积，实际编码时应避免使用本地的大图，而是采用网络图片
2. 小程序数据处理使用最频繁的接口是`setData`，错误使用该接口会导致数据处理延时和渲染延时
   - 正确的做法是不要将非渲染数据放入data属性中
   - 能够放在一起更新的数据尽量使用同一个setData更新
   - 不要在毫秒级的事件触发中调用setData，这会极大的影响程序运行
   - 更新数据时只更新必要部分，而不是整个对象、数组的更新
   - 尽量避免在后台调用setData，后台页面的渲染用户是无感知的且占用内存资源
3. 微信的微信开发者工具比较垃圾，尽量使用稳定版本，如果调试过程中发现程序突然报错无法正常运行，检查代码没有问题后，通常是开发者工具的锅，可尝试重启该工具解决
